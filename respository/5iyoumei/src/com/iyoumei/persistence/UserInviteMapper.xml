<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wuwaikeji.luyou.persistence.UserInviteMapper">
  <resultMap id="userAddInviteDomain" type="UserInviteDomain" >
    <id column="invite_id" property="inviteId" jdbcType="BIGINT"/>
    <result column="inviting_user_id" property="invitingUserId" jdbcType="BIGINT" />
    <result column="invited_user_id" property="invitedUserId" jdbcType="BIGINT" />
    <result column="source" property="source" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="VARCHAR" />
    <result column="link_time" property="linkTime" jdbcType="TIMESTAMP" />
    <result column="apply_time" property="applyTime" jdbcType="TIMESTAMP" />
    <result column="message" property="message" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Invite_Column_Map">
      invite_id,inviting_user_id,invited_user_id,source,status,link_time,apply_time,message
  </sql>
  <select id="selectByUserId" resultMap="userAddInviteDomain">
      select <include refid="Invite_Column_Map"/>
      from user_add_invite
      where inviting_user_id=#{invitingUserId} and invited_user_id=#{invitedUserId}
  </select>
  <select id="selectById" resultMap="userAddInviteDomain">
      select <include refid="Invite_Column_Map"/>
      from user_add_invite
      where invite_id=#{inviteId}
  </select>
	<!-- 检查二人是否应是好友 -->
	<select id="checkInvited00Relation"  resultType="_int">
		 select IFNULL(COUNT(*),0) from luyou.user_add_invite 
		 where (inviting_user_id=#{invitingUserId} or inviting_user_id=#{invitedUserId}) and status='00' 
	</select>
	
	<!-- 检查是否已经有好友添加请求，5分钟内禁止重复发送 -->
	<select id="checkInvited01Relation"  resultType="_int">
		 select IFNULL(COUNT(*),0) from luyou.user_add_invite 
		 where inviting_user_id=#{invitingUserId} and invited_user_id=#{invitedUserId} 
		 and status='01' and apply_time BETWEEN DATE_ADD(NOW(),INTERVAL -5 MINUTE) AND NOW() 
	</select>
	
	<!-- 添加好友申请 -->
	<insert id="insert">
		INSERT INTO luyou.user_add_invite 
		(invite_id,inviting_user_id, 
		invited_user_id, 
		source, 
		STATUS, 
		apply_time, 
		message
		)
		VALUES
		(uuid_short(),
		#{invitingUserId}, 
		#{invitedUserId}, 
		#{source}, 
		'01', 
		now(), 
		#{message}
		);
	</insert>
	<!-- 更新好友申请状态 -->
	<update id="update">
		UPDATE user_add_invite
		SET status=#{status},link_time=now()
		WHERE inviting_user_id=#{invitingUserId} AND invited_user_id=#{invitedUserId} AND STATUS='01' 
	</update>
</mapper>